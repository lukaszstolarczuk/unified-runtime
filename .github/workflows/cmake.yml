name: Build and test

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ubuntu-build:
    name: Build - Ubuntu
    runs-on: ubuntu-22.04
    steps:
    - name: test
      run: ls

  level-zero:
    name: Level Zero
    uses: ./.github/workflows/build-hw-reusable.yml
    with:
      name: L0

  opencl:
    name: OpenCL
    runs-on: ubuntu-22.04
    steps:
    - name: test
      run: echo "OpenCL"

  cuda:
    name: CUDA
    if: github.repository == 'oneapi-src/unified-runtime'  # run only on upstream; forks won't have the HW
    uses: ./.github/workflows/build-hw-reusable.yml
    with:
      name: CUDA

  e2e-level-zero:
    name: E2E L0
    permissions:
      contents: read
      pull-requests: write
    needs: [ubuntu-build, level-zero]
    uses: ./.github/workflows/e2e_level_zero.yml

  e2e-opencl:
    name: E2E OpenCL
    permissions:
      contents: read
      pull-requests: write
    needs: [ubuntu-build, opencl]
    uses: ./.github/workflows/e2e_opencl.yml
